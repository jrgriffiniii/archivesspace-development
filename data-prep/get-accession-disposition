require 'archivesspace/client'
require 'csv'
require_relative 'sandbox_auth'

#configure access
config = ArchivesSpace::Configuration.new({
  base_uri: "https://aspace.princeton.edu/staff/api",
  base_repo: "",
  username: @user,
  password: @password,
  #page_size: 50,
  throttle: 0,
  verify_ssl: false,
})

#log in
client = ArchivesSpace::Client.new(config).login

#get a count of ids
count_accession_ids = client.get('repositories/5/accessions', {
  query: {
    all_ids: true
  }}).parsed.count

#puts count_accession_ids

#get all ids
accession_ids = client.get('repositories/5/accessions', {
  query: {
   all_ids: true
  }}).parsed

#for each id, get the accession record and add to array of accession records
results = []
count_processed_records = 0
while count_processed_records < count_accession_ids do
  last_record = [count_processed_records+249, count_accession_ids].min
  results << client.get('repositories/5/accessions', {
          query: {
            id_set: accession_ids[count_processed_records..last_record]
          }
        })
  count_processed_records = last_record
  end

#iterate over accession record and write selected fields to csv
CSV.open("repo5.csv", "wb") do |row|
  results.each do |result|
    result.parsed.each do |record|
        disposition = record['disposition']
        accession_id =
          unless record['id_0'].nil?
            record['id_0']
          else ' '
          end
        row << [accession_id, disposition]
          end
  end
end
